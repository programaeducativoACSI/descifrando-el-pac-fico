<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gale√≥n de Manila - Archivo Digital Completo</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+DW+Pica&family=Pirata+One&display=swap" rel="stylesheet">

<style>
        :root { 
        --azul-p: #1b2631; 
        --pergamino: #fdf5e6; 
        --oro: #b2945d; 
        --tinta: #1a1a1a; 
        --verde-sello: #1e8449;
    }

    body, html { 
        margin: 0; padding: 0; 
        height: 100%; width: 100%; 
        font-family: 'IM Fell DW Pica', serif; 
        background: var(--azul-p); 
        overflow: hidden; 
    }

        #menu-roles { 
        display: flex; 
        flex-direction: column; 
        gap: 12px; 
        padding: 25px; 
        height: 100vh; 
        box-sizing: border-box; 
        justify-content: center; 
        background: radial-gradient(circle, #2e4053, #1b2631); 
        position: absolute; 
        width: 100%; 
        z-index: 3000; 
    }

    .tarjeta-rol { 
        background: var(--pergamino); 
        border: 4px double var(--oro); 
        padding: 15px; 
        text-align: center; 
        border-radius: 12px; 
        box-shadow: 0 8px 20px rgba(0,0,0,0.5); 
        cursor: pointer; 
        transition: transform 0.2s;
    }

    .tarjeta-rol:hover { transform: scale(1.02); }

    .tarjeta-rol h2 { 
        font-family: 'Pirata One', cursive; 
        margin: 0; 
        color: var(--azul-p); 
        font-size: 1.8rem; 
    }

 
    #map { 
        height: 100vh; 
        width: 100%; 
        position: absolute; 
        top: 0; 
        z-index: 1; 
        background: #aad3df; 
    }

        #panel-datos { 
        position: absolute; 
        bottom: 0px; 
        width: 100%; 
        left: 0%; 
        height: 45vh; 
        background: var(--pergamino); 
        border: 4px solid var(--oro); 
        border-radius: 20px; 
        z-index: 2000; 
        display: none; 
        flex-direction: column; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
    }

    .contenido-scroll { padding: 0 20px 20px 20px; overflow-y: auto; flex-grow: 1; }

    /* 5. ELEMENTOS DE BIT√ÅCORA */
    .bitacora { margin-top: 20px; border-top: 2px dashed var(--oro); padding-top: 15px; }
    
    .input-estilo { 
        width: 100%; padding: 12px; margin: 8px 0; 
        border: 1.5px solid var(--oro); border-radius: 8px; 
        box-sizing: border-box; font-family: inherit; 
    }

    .btn-file { 
        background: #546e7a; color: white; width: 100%; padding: 15px; 
        border: none; border-radius: 10px; font-family: 'Pirata One'; 
        font-size: 1.2rem; margin-bottom: 10px; cursor: pointer; 
    }

    .btn-enviar { 
        background: var(--verde-sello); color: white; border: none; 
        width: 100%; padding: 18px; border-radius: 12px; 
        font-family: 'Pirata One'; font-size: 1.4rem; cursor: pointer;
        box-shadow: 0 4px 12px rgba(30, 132, 73, 0.4);
    }

    .btn-accion { 
        background: var(--azul-p); color: white; width: 100%; padding: 15px; 
        border: none; border-radius: 10px; font-family: 'Pirata One'; 
        font-size: 1.3rem; margin-top: 10px; display: none; 
    }

    .btn-accion:disabled {
        background-color: #95a5a6 !important;
        cursor: not-allowed;
        opacity: 0.6;
    }

    /* 6. MODALES Y BIT√ÅCORA FLOTANTE */
    .btn-bitacora-flotante {
        position: fixed !important; top: 20px !important; right: 20px !important;
        background-color: #5dade2 !important; color: white !important;
        padding: 12px 20px !important; border-radius: 30px !important;
        z-index: 999999 !important; border: 2px solid white !important;
        font-family: 'Pirata One', cursive; cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.4); display: none;
    }

    #modal-bitacora {
        display: none; position: fixed; z-index: 1000000;
        left: 0; top: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.8);
    }

    .cerrar-modal {
        position: absolute; right: 20px; top: 15px;
        font-size: 35px; color: #78281f; font-weight: bold; cursor: pointer;
    }

    /* 7. PANTALLA FINAL (Animaci√≥n y Textura Papyrus) */
    #pantalla-final {
        background-image: url('https://www.transparenttextures.com/patterns/papyrus.png');
        background-color: rgba(0,0,0,0.95);
    }

    #pantalla-final > div {
        animation: aparecerFinal 1.2s ease-out;
    }

    @keyframes aparecerFinal {
        from { opacity: 0; transform: scale(0.8) translateY(20px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }

    #status-archivo { color: var(--verde-sello); font-weight: bold; text-align: center; margin-bottom: 10px; }
</style>
<body>
    <button id="btn-bitacora-global" onclick="abrirBitacoraCompartida()" class="btn-bitacora-flotante" style="display: none;">
        üìú BIT√ÅCORA DEL GREMIO
    </button>

    <div id="menu-roles" style="display: flex; flex-direction: column; align-items: center; overflow-y: auto; padding-top: 20px;">
        <div style="text-align: center; width: 100%; margin-top: 109px; margin-bottom: 0px; padding: 10px 0;">
            <img src="https://www.sanildefonso.org.mx/expos/somospacifico/images/logo_txt.png" 
                 alt="Somos Pac√≠fico" 
                 style="width: 50%; max-width: 260px; height: auto; filter: brightness(0) invert(1); display: inline-block;">
        </div>

        <div class="tarjeta-rol" style="margin-top: -10px !important; width: 90%;" onclick="accesoRol('Comerciante')">
            <h2>Comerciante</h2>
            <p>Acapulco ‚Üí Manila</p>
        </div>
        <div class="tarjeta-rol" style="width: 90%;" onclick="accesoRol('Cart√≥grafo')"><h2>Cart√≥grafo</h2><p>Acapulco ‚Üí Manila</p></div>
        <div class="tarjeta-rol" style="width: 90%;" onclick="accesoRol('Navegante')"><h2>Navegante</h2><p>Manila ‚Üí Acapulco</p></div>
        <div class="tarjeta-rol" style="width: 90%;" onclick="accesoRol('Artesano')"><h2>Artesano</h2><p>Manila ‚Üí Acapulco</p></div>

        <div style="text-align: center; margin-top: 30px; padding-bottom: 20px; opacity: 0.8;">
            <img src="" 
                 style="max-width: 110px; height: auto; filter: brightness(0) invert(1);">
        </div>
    </div>

    <div id="map"></div>

    <div id="panel-datos" style="display: none;">
        <div class="tirador"></div>
        <div class="contenido-scroll">
            <div class="header-sala">
                <span id="rol-nombre" style="background: var(--azul-p); color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.75rem;">ROL</span>
                <span id="sala-tag" style="font-weight: bold; color: var(--azul-p);">SALA 1/15</span>
                <span id="id-viajero-display" class="id-tag"></span>
            </div>

            <div class="card-historia">
                <h3 id="nombre-hito">Hito</h3>
                <p id="info-dato">Dato hist√≥rico...</p>
                <p id="info-pregunta" class="pregunta-box">Pregunta did√°ctica...</p>
            </div>

            <button id="btn-next" class="btn-accion" onclick="siguienteSala()" style="display: none;">Siguiente Sala ‚Üí</button>

            <div id="bitacora-container">
                <div class="bitacora">
                    <textarea id="texto-bitacora" class="input-estilo" placeholder="Escribe tu hallazgo..."></textarea>
                    <div id="status-archivo"></div> 
                    
                    <button type="button" class="btn-file" onclick="document.getElementById('archivo-oculto').click()">
                        üì∑ ADJUNTAR EVIDENCIA
                    </button>
                 <input type="file" id="archivo-oculto" 
       accept="image/*,audio/*,.m4a,.wav" 
       style="display: none;" 
       onchange="actualizarStatusArchivo()">
                    
                    <button onclick="enviarReporte()" class="btn-enviar">
                        üì© SELLAR REPORTE (continuar)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-bitacora" style="display: none; position: fixed; z-index: 10000000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center;">
        <div style="background: #fdf5e6; padding: 20px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; border: 3px double #b2945d;">
            <span onclick="document.getElementById('modal-bitacora').style.display='none'" style="float: right; cursor: pointer; font-size: 30px; font-weight: bold;">&times;</span>
            <h2 style="font-family: 'Pirata One'; color: #78281f; text-align: center;">Memorias de Navegantes</h2>
            <div id="lista-comentarios-modal"></div>
        </div>
    </div>

    <div id="pantalla-final" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); z-index: 20000000; justify-content: center; align-items: center; flex-direction: column;">
        <div style="text-align: center; border: 5px double #b2945d; background: #fdf5e6; padding: 40px; border-radius: 15px; max-width: 90%; width: 500px; box-shadow: 0 0 50px rgba(178, 148, 93, 0.5);">
            <h1 style="font-family: 'Pirata One', serif; font-size: 3rem; color: #78281f; margin-top: 0;">¬°EXPEDICI√ìN COMPLETADA!</h1>
            <hr style="border: 1px solid #b2945d; width: 80%; margin: 20px auto;">
            <p style="font-size: 1.2rem; line-height: 1.6; color: #1b2631;">
                Honorable <span id="final-rol" style="font-weight: bold; color: #78281f;"></span>, <br><br>
                Tus hallazgos han sido sellados en el <strong>Archivo del Pac√≠fico</strong>. 
                Gracias a tu pericia, la ruta permanece viva.
            </p>
            <div style="background: #eeeae0; padding: 15px; border-radius: 10px; margin: 25px 0; border: 1px dashed #78281f;">
                <p style="margin: 0; font-size: 0.9rem; color: #555;">ID DE VIAJERO:</p>
                <h2 id="final-id" style="margin: 5px 0; letter-spacing: 3px; color: #1b2631;"></h2>
            </div>
            <button onclick="location.reload()" style="background: #1b2631; color: white; padding: 15px 40px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold;">
                INICIAR NUEVA TRAVES√çA
            </button>
        </div>
    </div>

    <div id="contenedor-logo-mapa" style="position: fixed; top: 20px; left: 20px; z-index: 5000; pointer-events: none; display: none;">
    <img src="https://www.sanildefonso.org.mx/expos/somospacifico/images/logo_txt.png" 
         style="width: 140px; filter: brightness(0) invert(1); drop-shadow: 0 2px 4px rgba(0,0,0,0.5);">
</div>
</body>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- 1. CONFIGURACI√ìN GLOBAL Y SEGURIDAD ---
    let viajeroID = "VIAJERO-" + Math.floor(1000 + Math.random() * 9000);
   var map; // Usar var asegura que todas las funciones puedan mover el mapa.
    let salaActual = 1;
    let rolActivo = "";
    let rutaActual = [];

    const LLAVES_ACCESO = {
        "Comerciante": "Seda",
        "Cart√≥grafo": "Mapa",
        "Navegante": "Vela",
        "Artesano": "Taller"
    };

    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwMNAn0fcQogSy6-qiZGUYPUfcIr57tgPUV6icfrvmlglUz1IAbVd2rvNN3hsqyVVen/exec"; 

    // --- 2. RUTA BAS
 const rutaBase = [
    { n: "Puerto de Manila", lat: 14.59, lng: 120.98 },
    { n: "Estrecho de San Bernardino", lat: 12.58, lng: 124.28 },
    { n: "Mar de Filipinas", lat: 15.0, lng: 132.0 },
    { n: "Islas Marianas (Guam)", lat: 13.44, lng: 144.79 },
    { n: "Pac√≠fico Norte", lat: 30.0, lng: 160.0 },
    { n: "Corriente de Kuroshio", lat: 38.0, lng: 175.0 },
    { n: "Meridiano 180", lat: 40.0, lng: 180.0 }, 
    { n: "Alta Mar Central", lat: 38.0, lng: -165.0 }, 
    { n: "Zona de Albatros", lat: 35.0, lng: -145.0 },
    { n: "Costa de California", lat: 34.0, lng: -120.0 },
    { n: "Baja California", lat: 24.0, lng: -112.0 },
    { n: "Mar de Cort√©s", lat: 22.0, lng: -108.0 },
    { n: "Cabo Corrientes", lat: 20.4, lng: -105.6 },
    { n: "Costa de Michoac√°n", lat: 18.5, lng: -103.0 },
    { n: "Puerto de Acapulco", lat: 16.86, lng: -99.89 }
];

    // --- 3. BASE DE DATOS (Contenido del Museo) ---
    const baseDeDatos = {
        "Navegante": [
            { n: "Puerto de Manila", d: `La Biblioteca de los Tr√≥picos presenta una colecci√≥n de obras sobre Bali, destacando su papel clave en el arte del siglo XX m√°s all√° de su imagen de para√≠so tropical. A trav√©s de los viajes de Miguel Covarrubias en las d√©cadas de 1920 y 1930, se exploran las afinidades culturales entre Bali y el sur de M√©xico.`, p:`Toma una foto a uno de los mapas proyectados que se ajuste mejor a lo que deseas conocer durante esta nueva` },
            { n: "Estrecho de San Bernardino", d:`Antes de conquistar M√©xico-Tenochtitl√°n, Hern√°n Cort√©s entendi√≥ que el control del agua era clave. Desde su llegada, mand√≥ construir bergantines con materiales de sus propios barcos y, tras la derrota inicial, reorganiz√≥ sus fuerzas con apoyo ind√≠gena para fabricar trece naves que fueron llevadas al Lago de Texcoco. Estas embarcaciones hicieron posible el asedio naval que permiti√≥ avanzar en la conquista de la ciudad.`, p: `Toma una foto que represente dichos enfrentamientos Navales` },
            { n: "Mar de Filipinas", d: `Juan L√≥pez de Velasco (ca. 1530-1598) fue Cronista Mayor de Indias durante el reinado de Felipe II. Intervino en la realizaci√≥n de las topograf√≠as bas√°ndose en 51 preguntas que se realizaban para poder reunir toda una serie de informaci√≥n social, econ√≥mica, geogr√°fica, cultural, de cada uno de los pueblos, poblados, aldeas y ciudades que compon√≠an los dominios del rey.`, p: `Encuentra en la sala ‚ÄúEl Mapa General de √Ämerica el Oc√©ano Pacifico y la parte este de Asia‚Äù de 	Juan L√≤pez de Velasco` },
            { n: "Islas Marianas (Guam)", d: `De los 163 galeones que navegaron la ruta Acapulco‚ÄìManila durante 250 a√±os, s√≥lo cuatro fueron capturados por corsarios.El primer gale√≥n que cay√≥ fue el Santa Ana, de 700 toneladas y construido en Guatemala. En 1587, tomado por sorpresa, dos corsarios ingleses comandados por Thomas Cavendish, cerca de Cabo San Lucas. M√°s de cien a√±os despu√©s, en 1709, el corsario Woodes Rogers intent√≥ capturar varios galeones frente a las costas de California, pero solo logr√≥ quedarse con uno, el Nuestra Se√±ora de la Encarnaci√≥n. Eso, querido navegante, no es suerte, es estrategia.`, p: `Toma un foto de lo m√°s representativo para que el Gale√≥n se defendiera` },
            { n: "Pac√≠fico Norte", d: `Durante 250 a√±os, los galeones de la ruta Acapulco-Manila, transportaron los m√°s diversos productos del archipi√©lago malayo, de Indonesia, Indochina, China, Jap√≥n y la India. Construida de acero en el siglo XVII para asegurar la plata que surcaba los mares.`, p: `Toma un foto del articulo descrito para transportar la plata ` },
            { n: "Corriente de Kuroshio", d: `Con la ruta transpac√≠fica, comerciantes chinos se establecieron en las afueras de Manila, concentrados en un solo edificio llamado pari√°n, cuyo nombre en tagalo significa ‚Äúmercado chino‚Äù. Este mercado estaba ubicado a tiro de ca√±√≥n de las fortificaciones, para vigilar y controlar el comercio`, p: `Encuentra el ‚ÄúArcon Filipino‚Äù y toma una foto de la ilustraci√≥n del Pari√°n` },
            { n: "Meridiano 180", d: `China envi√≥ grandes cantidades de porcelana a Nueva Espa√±a en los galeones de Manila. Las primeras piezas llegaron durante la dinast√≠a Ming (1368‚Äì1644) y, m√°s tarde, la porcelana alcanz√≥ su mayor esplendor art√≠stico con la dinast√≠a Qing (1644‚Äì1912), especialmente en los reinados de Kangxi (1662‚Äì1722) y Qianlong (1735‚Äì1796).`, p: `Usa tu habilidad, navegante, y rastrea en que pieza de porcelana se encuentra el Gale√≥n` },
            { n: "Alta Mar Central", d: `Este producto es de seda bordada al estilo de las mantillas de Manila. Santa Rosa de Lima es la primera santa americana y tuvo una gran devoci√≥n arraigada con la identidad del territorio. La principal carga de los galeones fueron los productos textiles de China e India.`, p: `Usa tu habilidad, navegante, y rastrea la pieza descrita, encuentrala y toma una foto. ` },
            { n: "Zona de Albatros", d: `El naufragio del gale√≥n San Felipe en 1596 provoc√≥ la ira de Toyotomi Hideyoshi y tuvo graves consecuencias. Adem√°s de p√©rdidas econ√≥micas de un mill√≥n y medio de pesos, el suceso deriv√≥ en la crucifixi√≥n de 1597, dejando una lecci√≥n clave sobre los riesgos de la navegaci√≥n.`, p: `¬øC√≥mo alterar√≠a tu desembarco la noticia de los m√°rtires franciscanos para desembarcar en jap√≥n?` },
            { n: "Costa de California", d: `Proximamente10`, p: `Proximamente10` },
            { n: "Punta de Baja California", d: `Proximamente`, p: `Proximamente` },
            { n: "Mar de Cort√©s", d: "Dato 12", p: "¬øPregunta 12?" },
            { n: "Cabo Corrientes", d: "Dato 13", p: "¬øPregunta 13?" },
            { n: "Costa de Michoac√°n", d: "Dato 14", p: "¬øPregunta 14?" },
            { n: "Puerto de Acapulco", d: "Dato 15", p: `Proximamente15` }
        ],
        "Artesano": [
            { n: "Puerto de Manila", d:  `Esta escultura fue encontrada en las inmediaciones de la Acr√≥polis de la ciudad de Xochicalco, Morelos. Se le llama ‚ÄúEl creador‚Äù un adulto arrodillado sobre su pierna, barbado y con colmillos de jaguar, porta un tocado con el s√≠mbolo del a√±o y tambi√©n orejeras`, p:  `Querido artesano, toma una foto, ¬øcual es la pieza de la que se habla en la descripci√≥n?` },
            { n: "Estrecho de San Bernardino", d:  `Autor no identificado:  El biombo de la Conquista de M√©xico Finales del siglo XVII √ìleo sobre tela y madera dorada Colecci√≥n Museo Nacional de Historia, Castillo de Chapultepec, Secretar√≠a de Cultura-INAH`, p:  `Toma una foto que represente la atenci√≥n al detalle y la tecnica de tu oficio en el Biombo` },
            { n: "Mar de Filipinas", d:  `Gualdras de la iglesia principal de Longos Laguna, Filipinas Siglo XVI madera de molavecolecci√≥n Rodrigo Rivero Lake. Arte y Antig√ºedades el molave es un √°rbol nativo del Sudeste Asi√°tico, cuya madera densa y duradera fue utilizada tanto en la construcci√≥n de casas e iglesias como en los galeones que atravesaban el oc√©ano Pac√≠fico.`, p:  `De acuerdo a la descripci√≥n busca en la sala la pieza que describe y tomale una foto. ` },
            { n: "Islas Marianas (Guam)", d: `Durante m√°s de 250 a√±os, los galeones zarparon una vez al a√±o. Una pieza artesanal no se consideraba terminada hasta sobrevivir la traves√≠a. Muchas obras se perd√≠an por malas t√©cnicas de embalaje o por no considerar el movimiento del barco, lo que oblig√≥ a los artesanos a pensar no solo en la est√©tica, sino en la resistencia f√≠sica del objeto.`, p:  `Toma una foto que represente la mercanc√≠a con mayor resistencia` },
            { n: "Pac√≠fico Norte", d: `Desde el siglo XVI, la plata extra√≠da en minas como Zacatecas, Taxco y San Luis Potos√≠ circul√≥ por Asia en forma del peso de ocho reales. Esta moneda se volvi√≥ tan confiable que incluso fue aceptada en China. Su abundancia impuls√≥ la demanda de objetos artesanales lujosos, altamente decorados, destinados a una √©lite capaz de pagar con plata.`, p:  `Toma una foto que represente el objeto m√°s valioso de la sala` },
            { n: "Corriente de Kuroshio", d: `En la plaza mayor de la Ciudad de M√©xico existi√≥ primero el mercado El Baratillo, destruido por un incendio en 1692, lo que llev√≥ a la construcci√≥n del Pari√°n, un mercado permanente frente a la catedral, terminado en 1703 y ampliado hasta 1720`, p:  `Toma una foto en la pintura que te represente como Artesano ` },
            { n: "Meridiano 180", d: `China envi√≥ grandes cantidades de porcelana a Nueva Espa√±a en los galeones de Manila. Las primeras piezas llegaron durante la dinast√≠a Ming (1368‚Äì1644) y, m√°s tarde, la porcelana alcanz√≥ su mayor esplendor art√≠stico con la dinast√≠a Qing (1644‚Äì1912),especialmente en los reinados de Kangxi (1662‚Äì1722) y Qianlong (1735‚Äì1796).`, p:  `Toma una foto del objeto que consideres menos valioso.` },
            { n: "Alta Mar Central", d: `El cristianismo se difundi√≥ a trav√©s del Gale√≥n de Manila mediante im√°genes religiosas producidas y comercializadas en serie. Porcelanas chinas y bordados filipinos se usaron para decorar altares. El marfil fue tallado por artesanos chinos en Manila (sangleyes), creando el estilo hispano-filipino, inspirado en grabados flamencos. El estilo indo-portugu√©s, hecho en la India, represent√≥ figuras cristianas con posturas similares a las de Buda.`, p:  `Artesano: mu√©stranos un ejemplo de c√≥mo utilizaste alguno de estos materiales o t√©cnicas para crear arte sacro (Religioso)` },
            { n: "Zona de Albatros", d: `Estos guerreros conformaban una clase social privilegiada de guerreros de √©lite en el Jap√≥n antiguo y durante el periodo Edo o Tokugawa (1603-1868). Edo se refiere a Tokio, periodo en que se traslada la capital imperial de Kioto a esta ciudad. Su armadura estaba hecha de l√°mina de hierro y cuero laqueados, textil y detalles en bronce y oro.`, p:  `Artesano, de acuerdo a la descripci√≥n menciona el nombre de estos guerreros y toma una foto a su armadura. ` },
            { n: "Costa de California", d: `Proximamente 10`, p:  `Toma una foto del mant√≥n de Manila` },
            { n: "Punta de Baja California", d: `Proximamente`, p:  `Proximamente` },
            { n: "Mar de Cort√©s", d: "Dato 12", p:  `Proximamente` },
            { n: "Cabo Corrientes", d: "Dato 13", p:  `Proximamente` },
            { n: "Costa de Michoac√°n", d:  `Proximamente 14`, p:  `Proximamente` },
            { n: "Puerto de Acapulco", d:  `Proximamente`, p:  `Proximamente` }
        ],
        "Cart√≥grafo": [
            { n: "Puerto de Acapulco", d:`El cacao, de origen mexicano, fue un bien de gran valor: adem√°s de consumirse, funcion√≥ como moneda en Mesoam√©rica. Las deidades asociadas a √©l representan su poder econ√≥mico y su papel como uno de los primeros productos agr√≠colas exportados masivamente hacia las islas.`, p: `Busca la pieza que creas que tendr√≠a el valor m√°s alto en el mercado de ‚Äúcuriosidades‚Äù de la √©poca. Toma una fotograf√≠a y escribe como pie de foto: 'Precio estimado:..` },
            { n: "Costa de Michoac√°n", d:`El C√≥dice Florentino no solo documenta aspectos culturales, sino tambi√©n descripciones del territorio que ayudaron a la Corona a comprender su organizaci√≥n. Estas representaciones fueron un antecedente clave para el desarrollo de mapas que conectaban el centro de M√©xico con los puertos de Acapulco y Veracruz.`,p:`Encuentra el Biombo de la Conquista. T√≥male una foto a tu detalle favorito y responde: Si este biombo fuera un 'mapa' de la ciudad, ¬øqu√© edificio usar√≠as como punto de referencia para no perderte?`},
            { n: "Cabo Corrientes",  d:`En 1734, Joseph Gonz√°lez Cabrera Bueno public√≥ en Manila la gu√≠a m√°s importante para cruzar el Pac√≠fico. Sus mapas eran tan precisos que ayudaban a evitar los "bajos" (arrecifes) que pod√≠an hundir el Gale√≥n.`,p:`Busca libro ‚Äúvoyage around the World de George Anson‚Äù y tomale una foto`},
            { n: "Mar de Cort√©s",  d:`El Cart√≥grafo usaba el Reloj Solar y la Calcograf√≠a (mapas impresos en cobre) para calcular la ruta exacta.`,p:`Mira el Reloj Solar. D√≠a 150 en el mar. El sol marca nuestra posici√≥n. Seg√∫n mis c√°lculos, estamos cerca de las Islas Marianas ¬ø Qu√© colocar√≠as en tu bit√°cora de viaje? graba un audio`},
            { n: "Punta de Baja California",  d:`La Ciudad de M√©xico era el eje financiero de la ruta. Aqu√≠, la Plata Mexicana (reales de a ocho) se convert√≠a en la primera moneda global. Los mapas de los puertos (Acapulco y Veracruz) no estaban aislados: el Cart√≥grafo deb√≠a conocer el camino terrestre que los un√≠a para asegurar que la plata llegara a los barcos a tiempo`,p:`Observa los cuadros de los puertos, que puerto consideras que cobra mayor importancia y por qu√©`},
            { n: "Costa de California",  d:`El cuadro del Z√≥calo es un ejercicio de cartograf√≠a te√≥rica. El autor utiliz√≥ descripciones para ubicar el Pari√°n y los puestos, demostrando que en el siglo XVIII, un mapa pod√≠a ser tan fiel como la informaci√≥n que se enviaba por barco, permitiendo que alguien en Europa ‚Äúviera‚Äù la Ciudad de M√©xico.`,p:`Como Cart√≥grafo, ¬øqu√© tan dif√≠cil crees que fue para el autor dibujar estas calles sin haberlas caminado nunca?`},
            { n: "Zona de Albatros",  d:`La palabra "petaca" (que hoy asociamos a algo peque√±o) se usaba originalmente para designar una maleta o cofre hecho de palma tejida donde se transportaba el tabaco y el cacao`,p:`Si tuvieras que usar un emoji para representar el cacao en un mapa ¬øcu√°l usar√≠as?`},
            { n: "Alta Mar Central", d:`Los textos navales de Cabrera Bueno muestran c√≥mo la geograf√≠a y la religi√≥n estaban estrechamente ligadas. En el Estrecho de San Bernardino, donde las corrientes eran extremadamente peligrosas, los navegantes confiaban m√°s en la protecci√≥n de la Virgen de la Gu√≠a que en los mapas para atravesar el archipi√©lago.`,p:`Seg√∫n tu experiencia de trazos y dibujos ¬øC√∫al de estas piezas es m√°s dif√≠cil y por qu√©?`},
            { n: "Meridiano 180", d:`El naufragio del gale√≥n San Felipe en 1596 provoc√≥ la ira de Toyotomi Hideyoshi y tuvo graves consecuencias. Adem√°s de p√©rdidas econ√≥micas de un mill√≥n y medio de pesos, el suceso deriv√≥ en la crucifixi√≥n de 1597, dejando una lecci√≥n clave sobre los riesgos de la navegaci√≥n`,p:`¬øC√≥mo alterar√≠a tu desembarco la noticia de los m√°rtires franciscanos para desembarcar en jap√≥n`},
            { n: "Corriente de Kuroshio",  d:`Palabras cotidianas como el agua llegaron a Filipinas desde Nueva Espa√±a. Este intercambio ling√º√≠stico evidencia el papel del territorio como un ‚Äúpuente‚Äù que conecta materiales y culturas a ambos lados del oc√©ano.`,p:`Si tuvieras la encomienda de llevar alguna de estas piezas a un noble novohispano, ¬øcual elegir√≠as? tomale una foto`},
            { n: "Pac√≠fico Norte",  d:`El sistema termin√≥ en 1815, justo cuando M√©xico buscaba su soberan√≠a. Para tu oficio, esto signific√≥ que los mapas dejaron de ser "Secretos de Estado" de la Corona Espa√±ola para convertirse en los mapas de una nueva naci√≥n, transformando la cartograf√≠a militar en cartograf√≠a civil y art√≠stica.`,p:`Graba una nota de voz dirigida a los antiguos tripulantes del Gale√≥n. Expl√≠cales que, aunque el Gale√≥n ya no navega, la 'ruta' que trazaron sigue viva en el arte y en la identidad de la gente`},
            { n: "Islas Marianas (Guam)",  d:`Como Cart√≥grafo, ves en los murales de Rivera la confirmaci√≥n de tu trabajo: M√©xico no es solo un destino, sino el eje central de un mapa global que t√∫ ayudaste a definir y que el muralismo ahora celebra como identidad.`,p:`Toma una foto del de algun elemento de la sala que te recuerde la importacia de la tierra y de los mapas.`},
            { n: "Mar de Filipinas", d: "Proximamente", p: "Proximamente" },
            { n: "Estrecho de San Bernardino", d: "Proximamente 14", p: "¬øProximamente 14?" },
            { n: "Puerto de Manila", d: "Proximamente 15", p: "¬øProximamente 15?" }
        ],
        "Comerciante": [
            { n: "Puerto de Acapulco", d: `El cacao, de origen mexicano, fue un bien de gran valor: adem√°s de consumirse, funcion√≥ como moneda en Mesoam√©rica. Las deidades asociadas a √©l representan su poder econ√≥mico y su papel como uno de los primeros productos agr√≠colas exportados masivamente hacia las islas.`, p:`Busca la pieza que creas que tendr√≠a el valor m√°s alto en el mercado de 'curiosidades' de la √©poca. Toma una fotograf√≠a y escribe como pie de foto: 'Precio estimado:...'`  },
            { n: "Costa de Michoac√°n", d: `El biombo como mercanc√≠a de lujo:Los biombos formaban parte de los objetos m√°s codiciados por los sectores m√°s ricos de la Nueva Espa√±a. La pieza que tienes frente a ti pudo haber sido adquirida por un virrey o un comerciante acaudalado, mostrando c√≥mo el arte tambi√©n fue un negocio altamente rentable.`, p: `¬øCu√°l ser√≠a el m√©todo para resguardar el biombo que usar√≠as si lo tuvieras que llevar al centro de la Ciudad de M√©xico para su venta?` },
            { n: "Cabo Corrientes", d: `Las bit√°coras que ves en la sala registraban legalmente los bienes de lujo autorizados para cruzar el oc√©ano, garantizando un comercio sin competencia ilegal.`, p: `¬øQu√© consideras que ser√≠a una ‚Äúmercanc√≠a legal‚Äù?` },
            { n: "Mar de Cort√©s", d: `El contacto y comercio entre M√©xico y Filipinas se mantuvo durante m√°s de 250 a√±os. La manta que narra un viaje de m√°s de 200 d√≠as simboliza el tiempo de maduraci√≥n de la inversi√≥n: cada d√≠a en el mar incrementan los riesgos, desde el da√±o al casco hasta la humedad que pod√≠a arruinar la carga y reducir las ganancias finales.`, p: `Imagina que llevas meses en El Gale√≥n, que te preocupa m√°s por tus productos, la humedad, el movimiento, el ataque de corsarios o alguna otra cosa que te pudiera hacer perder tu inversi√≥n?Graba un audio` },
            { n: "Punta de Baja California", d: `Carga l√≠mite (valor de mercanc√≠a): Exist√≠a un l√≠mite de carga llamada ‚Äúpermisi√≥n‚Äù en diversas √©pocas, se permitir la exportaci√≥n de 250,000 monedas desde Manila y el retorno de 500,00 monedas en plata desde Acapulco`, p: `Identifica la moneda de ocho reales de 1804 y tomale una foto` },
            { n: "Costa de California", d: `El pari√°n era un mercado especializado en bienes de lujo. Surgido en Manila como espacio para el comercio chino, su modelo fue tan exitoso que se replic√≥ en la Plaza Mayor de la Ciudad de M√©xico, como muestran la maqueta y la pintura. Aqu√≠ se concentraba y controlaba la venta de seda, marfil y porcelana.`, p: `Toma una foto en la pintura de la plaza donde colocarias tu puesto` },
            { n: "Zona de Albatros", d: `Porcelana de importaci√≥n:Las vajillas de porcelana china fueron uno de los productos m√°s valiosos del comercio transpac√≠fico. Las piezas que ves en la sala no son solo objetos art√≠sticos: eran art√≠culos de alto valor que generaban grandes ganancias al llegar a la Ciudad de M√©xico`, p: `¬øCu√°les son los principales colores de la porcelana que hay en la sala?` },
            { n: "Alta Mar Central", d: `Aunque se ten√≠a una ley para poner l√≠mite al cargamento, en la pr√°ctica el valor de los transportado era mucho mayor. Se estima que en el siglo XVIII se llegaba a despachar hasta 2.5 millones de monedas de plata de retorno, superando por mucho el permiso oficial.`, p: `¬øQu√© Piezas le vender√≠as a un sacerdote novohispano, de las que hay en la sala?` },
            { n: "Meridiano 180", d:`El sistema de licencias (Shuinsen):La misi√≥n diplom√°tica del noble samur√°i Hasekura Tsunenaga, conocida como Embajada Keich√∂, fue una delegaci√≥n japonesa enviada a la Nueva Espa√±a por Date Masamune, daimyo de Sendai, entre 1613 y 1620.`, p: `Describe cu√°l era el objetivo principal de esta misi√≥n` },
            { n: "Corriente de Kuroshio", d: `El mercado del mestizaje cultural:La conquista de Filipinas dio origen a un intenso mestizaje cultural y social. Los trajes de los mestizos reflejan esta mezcla y revelan una nueva oportunidad comercial: prendas que combinan la elegancia europea con materiales asi√°ticos, destinadas a una clase social emergente y con demandas propias.`, p: `¬øEn qu√© condiciones crees que se deber√≠a de transportar las prendas?` },
            { n: "Pac√≠fico Norte", d: `El Gale√≥n fue un sistema que dur√≥ de 1565 a 1815. Como comerciante, este es el dato del "cierre de la empresa" tras 250 a√±os, el modelo de monopolio que te proteg√≠a dej√≥ de ser rentable debido a las guerras de independencia en M√©xico y la presi√≥n de nuevas potencias comerciales.`, p: `¬øQu√© objeto crees que haya sido el m√°s dif√≠cil de conseguir una vez el Gale√≥n dej√≥ de navegar?` },
            { n: "Islas Marianas (Guam)", d: `Las obras de Rivera en esta sala son el producto final de ese mestizaje. Como mercader, entiendes que la riqueza de M√©xico hoy reside en esa mezcla √∫nica que t√∫ mismo ayudaste a transportar en tus barcos siglos atr√°s.`, p: `Busca en las pinturas alg√∫n elemento que te recuerde a la riqueza del ¬¥pasado (como el color de la tierra, el trabajo manual) y t√≥male una fotograf√≠a` },
            { n: "Mar de Filipinas", d: `Proximamente`, p: `Proximamente` },
            { n: "Estrecho de San Bernardino", d: `Proximamente`, p: `Proximamente` },
            { n: "Puerto de Manila", d: `Proximamente`, p: `Proximamente` },
        ]
    };

function renderPoint(id, auto = false) {
    const hito = rutaActual[id - 1];
    const info = baseDeDatos[rolActivo][id - 1];

    if (!hito || !info) return;

    // --- 1. RESTAURAR INTERFAZ (Saca a la luz lo oculto en Sala 0) ---
    const zonaEscritura = document.querySelector('.area-bitacora'); 
    const zonaCarga = document.querySelector('.upload-container'); 
    
    if(zonaEscritura) zonaEscritura.style.display = 'block';
    if(zonaCarga) zonaCarga.style.display = 'block';

    // --- 2. LIMPIEZA DE CAPAS PREVIAS ---
    // Esto evita que el mapa se sature de memoria al avanzar salas
    map.eachLayer((layer) => {
        if (layer instanceof L.Marker || layer instanceof L.Polyline) {
            map.removeLayer(layer);
        }
    });

    // --- 3. CREAR MARCADOR ---
    const marker = L.marker([hito.lat, hito.lng]).addTo(map);

    marker.on('click', () => {
        // Actualizaci√≥n de textos en el panel
        document.getElementById('nombre-hito').innerText = info.n;
        document.getElementById('info-dato').innerText = info.d;
        document.getElementById('info-pregunta').innerText = info.p;
        document.getElementById('sala-tag').innerText = `Sala ${id}/15`;

        // Configuraci√≥n del bot√≥n de avance
        const btnNext = document.getElementById('btn-next');
        if (btnNext) {
            btnNext.style.display = 'block';
            btnNext.disabled = true;
            btnNext.innerText = "üîí RESPONDE PARA AVANZAR";
            // Aseguramos el color original por si venimos de la sala 15
            btnNext.style.background = "var(--oro)"; 
        }

        // Limpieza de campo de texto para nueva entrada
        document.getElementById('texto-bitacora').value = "";

        // Movimiento de c√°mara al punto exacto
        map.flyTo([hito.lat, hito.lng], 5, { 
            animate: true,
            duration: 1.5 
        });
        
        if (window.cargarComentarios) cargarComentarios(info.n);
    });

    // --- 4. DIBUJAR RUTA (L√≠nea punteada) ---
    if (id > 1) {
        const hitoAnterior = rutaActual[id - 2];
        L.polyline(
            [[hitoAnterior.lat, hitoAnterior.lng], [hito.lat, hito.lng]],
            { 
                color: '#1b2631', 
                weight: 3, 
                dashArray: '8, 12', 
                opacity: 0.6 
            }
        ).addTo(map);
    }

        // Si auto es true, el marcador se "presiona" solo (√∫til para el bot√≥n Siguiente)
    if (auto) {
        setTimeout(() => marker.fire('click'), 300);
    }
}
function siguienteSala() {
    if (salaActual < 15) {
        salaActual++;
        // El 'true' activa el movimiento autom√°tico del mapa
        renderPoint(salaActual, true); 
        
        const btnNext = document.getElementById('btn-next');
        if (btnNext) btnNext.style.display = 'none';
    } else {
        // Pantalla final
        document.getElementById('pantalla-final').style.display = 'flex';
        document.getElementById('panel-datos').style.display = 'none';
    }
}

function accesoRol(rol) {
    const pass = prompt(`Ingrese la contrase√±a de acceso para el perfil de ${rol}:`);
    
    if (pass === LLAVES_ACCESO[rol]) {
        // 1. Configuraci√≥n de datos
        rolActivo = rol;
        salaActual = 1;
        rutaActual = (rol === "Cart√≥grafo" || rol === "Comerciante") ? [...rutaBase].reverse() : [...rutaBase];
        
        if (!viajeroID) {
            viajeroID = "VIA-" + Math.floor(Math.random() * 9000 + 1000);
        }

        // 2. Interfaz: Mostrar panel y Textos de Bienvenida (Sala 0)
        document.getElementById('menu-roles').style.display = 'none';
        document.getElementById('panel-datos').style.display = 'flex';
document.getElementById('menu-roles').style.display = 'none';
        document.getElementById('rol-nombre').innerText = rol.toUpperCase();
        document.getElementById('id-viajero-display').innerText = viajeroID;
        

        // Mensajes de Bienvenida
        document.getElementById('nombre-hito').innerText = "¬°BIENVENIDO, " + rol.toUpperCase() + "!";
        document.getElementById('info-dato').innerText = "La traves√≠a est√° a punto de comenzar. El mapa ha sido desplegado para mostrarte la ruta comercial.";
        document.getElementById('info-pregunta').innerText = "INSTRUCCI√ìN: Col√≥quese en el primer marcador que aparece en el mapa para iniciar la misi√≥n.";
        document.getElementById('sala-tag').innerText = "Inicio de Misi√≥n";


const logoMapa = document.getElementById('contenedor-logo-mapa');
        if(logoMapa) logoMapa.style.display = 'block';
        // OCULTAR INTERACCI√ìN (Para que sea una Sala 0 limpia)
        const zonaEscritura = document.querySelector('.area-bitacora'); 
        const zonaCarga = document.querySelector('.upload-container'); 
        if(zonaEscritura) zonaEscritura.style.display = 'none';
        if(zonaCarga) zonaCarga.style.display = 'none';

        const btnNext = document.getElementById('btn-next');
        if (btnNext) btnNext.style.display = 'none';

        if(document.getElementById('btn-bitacora-global')) {
            document.getElementById('btn-bitacora-global').style.display = 'block';
        }

        // 3. Inicializar Mapa
        initMap();

        setTimeout(() => {
            // Buscamos el primer punto de la ruta (Manila o Acapulco)
            const primerHito = rutaActual[0];

            if (map && primerHito) {
                // AGREGAR EL MARCADOR INICIAL (Para que el usuario tenga d√≥nde clickear)
                const markerInicio = L.marker([primerHito.lat, primerHito.lng]).addTo(map);
                
                // Hacemos que este marcador tambi√©n dispare el renderPoint al tocarlo
                markerInicio.on('click', () => {
                    renderPoint(1); 
                });

                console.log("Posicionando en origen para " + rol + ":", primerHito.n);
                
                // Volamos al punto inicial
                map.flyTo([primerHito.lat, primerHito.lng], 5, {
                    animate: true,
                    duration: 2.5
                });
            }
        }, 600);

    } else {
        alert("Contrase√±a incorrecta. El Archivo Real permanece cerrado.");
    }
}
function initMap() {
    // Limpiamos si ya existe
    if (map && map.remove) {
        map.remove();
    }
    
    // Vista inicial oce√°nica
    map = L.map('map', { 
        zoomControl: false,
        worldCopyJump: true 
    }).setView([20, 0], 2);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
    
    // Tu efecto est√©tico
    document.getElementById('map').style.filter = "sepia(0.3) hue-rotate(185deg) brightness(0.9)";
    
    // Ajuste t√©cnico de tama√±o
    setTimeout(() => { map.invalidateSize(); }, 400);
    
    // NOTA: Aqu√≠ ya no hay renderPoint(1), por eso ya no sale el cuadro vac√≠o.
}
// --- 1. FUNCI√ìN PARA ENVIAR REPORTE (VALIDACI√ìN FLEXIBLE Y IPHONE) ---
async function enviarReporte() {
    const textoElement = document.getElementById('texto-bitacora');
    const texto = textoElement ? textoElement.value : "";

    // L√≥gica de "Salto de Sala" (C√≥digo secreto)
    if (texto.trim().toUpperCase() === "KNAAN") {
        salaActual = 15; 
        renderPoint(salaActual); 
        const btnNext = document.getElementById('btn-next');
        if (btnNext) {
            btnNext.disabled = false;
            btnNext.style.display = "block";
            btnNext.innerText = "üìú FINALIZAR TRAVES√çA";
            btnNext.style.background = "#78281f";
        }
        if (textoElement) textoElement.value = ""; 
        return; 
    }

    const inputArchivo = document.getElementById('archivo-oculto');
    const archivo = inputArchivo ? inputArchivo.files[0] : null;
    const hitoNombre = baseDeDatos[rolActivo][salaActual - 1].n;

    // --- CORRECCI√ìN: VALIDACI√ìN FLEXIBLE ---
    // Ahora permite enviar SI HAY texto O SI HAY archivo. Solo bloquea si ambos faltan.
    if (!texto.trim() && !archivo) {
        alert("Navegante, debes escribir un hallazgo o adjuntar una evidencia (foto/audio) para sellar el reporte.");
        return;
    }

    let payload = {
        idVisitante: viajeroID,
        rol: rolActivo,
        punto: hitoNombre,
        texto: texto,
        archivoB64: null,
        tipoMime: null,
        nombreArchivo: null
    };

    if (archivo) {
        const reader = new FileReader();
        const base64Promise = new Promise((resolve) => {
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(archivo);
        });
        
        payload.archivoB64 = await base64Promise;
        
        // --- CORRECCI√ìN PARA IPHONE ---
        let mime = archivo.type;
        // Si iOS no detecta el tipo pero es un archivo de audio com√∫n de Apple
        if (!mime && archivo.name.toLowerCase().endsWith('.m4a')) {
            mime = "audio/mp4"; 
        }
        
        payload.tipoMime = mime;
        payload.nombreArchivo = archivo.name;
    }

    // Llamamos a la funci√≥n que ya tienes para hacer el fetch
    enviarFetch(payload);
}

// --- FUNCI√ìN PARA MOSTRAR LA BIT√ÅCORA ---
function abrirBitacoraCompartida() {
    const modal = document.getElementById('modal-bitacora');
    const lista = document.getElementById('lista-comentarios-modal');
    const hitoElement = document.getElementById('nombre-hito');
    const hitoActual = hitoElement ? hitoElement.innerText : "";

    if (!hitoActual || hitoActual === "Hito") return alert("Selecciona un punto primero.");

    modal.style.display = "block";
    lista.innerHTML = "<p style='text-align:center;'>Buscando bit√°coras de " + rolActivo + "...</p>";

    fetch(APPS_SCRIPT_URL)
    .then(res => res.json())
    .then(data => {
        // Filtramos por Punto y Rol
        const filtrados = data.filter(d => d.punto === hitoActual && d.rol === rolActivo);
        
        if (filtrados.length === 0) {
            lista.innerHTML = `<p style='text-align:center; padding:20px;'>Nadie del gremio de <b>${rolActivo}s</b> ha dejado evidencias aqu√≠.</p>`;
            return;
        }

        // Aqu√≠ es donde el JavaScript genera el HTML din√°micamente
        lista.innerHTML = filtrados.map(d => `
            <div class="comentario-item" style="background:white; padding:15px; border-radius:10px; margin-bottom:15px; border-left: 5px solid #5dade2; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <small style="color:#7f8c8d;">ID: ${d.id || 'An√≥nimo'}</small>
                <p style="margin:8px 0; font-size: 1rem; color: #1b2631;">${d.texto || "<i style='color:gray;'>Sin comentario escrito</i>"}</p>
                ${crearElementoMultimedia(d.archivo)}
            </div>
        `).join("");
    })
    .catch(err => {
        console.error("Error al cargar:", err);
        lista.innerHTML = "Error al conectar con el Archivo Real.";
    });
}

// --- ESTA FUNCI√ìN DECIDE SI ESCRIBE HTML DE AUDIO O DE IMAGEN ---
function crearElementoMultimedia(url) {
    if (!url || url === "" || url === "null" || url === "undefined") return "";

    const link = url.toLowerCase();
    
    // Detectamos si es audio (por extensi√≥n o por el prefijo que pusimos en enviarReporte)
    const esAudio = link.includes("audio") || 
                    link.endsWith(".m4a") || 
                    link.endsWith(".mp3") || 
                    link.endsWith(".wav") || 
                    link.endsWith(".webm") ||
                    link.includes("uc?export=download");

    if (esAudio) {
        // Genera el HTML del reproductor de audio
        return `
            <div style="margin-top:10px; background: #f4f7f7; padding: 12px; border-radius: 8px; border: 1px solid #d5dbdb;">
                <p style="font-size:0.7rem; margin-bottom:8px; color: #78281f; font-weight: bold;">üéôÔ∏è EVIDENCIA SONORA</p>
                <audio controls style="width: 100%; height: 35px;">
                    <source src="${url}" type="audio/mp4">
                    <source src="${url}" type="audio/mpeg">
                    <source src="${url}" type="audio/webm">
                    Tu navegador no soporta la reproducci√≥n de audio.
                </audio>
            </div>
        `;
    } else {
        // Genera el HTML de la imagen
        // Si falla (onerror), oculta el cuadro para que no se vea el icono roto
        return `
            <div style="margin-top:10px;">
                <img src="${url}" 
                     style="width:100%; border-radius:10px; border: 1px solid #b2945d; display: block;" 
                     onerror="this.style.display='none';">
            </div>
        `;
    }
}

function cerrarBitacora() {
    const modal = document.getElementById('modal-bitacora');
    if(modal) modal.style.display = "none";
}
function cerrarBitacora() {
    const modal = document.getElementById('modal-bitacora');
    if(modal) modal.style.display = "none";
}
// --- 3. FUNCI√ìN MULTIMEDIA (SOPORTE TOTAL IPHONE/ANDROID) ---
function crearElementoMultimedia(url) {
    if (!url || url === "" || url === "null") return "";

    const link = url.toLowerCase();

    // Detectar si es AUDIO (por nombre de archivo o contenido)
    if (link.includes("audio") || link.endsWith(".m4a") || link.endsWith(".mp3") || link.endsWith(".wav") || link.endsWith(".webm")) {
        return `
            <div style="margin-top:10px; background: #f8f9f9; padding: 10px; border-radius: 8px; border: 1px solid #d6dbdf;">
                <p style="font-size:0.7rem; margin-bottom:5px; color: #78281f; font-weight: bold;">üéôÔ∏è EVIDENCIA DE AUDIO:</p>
                <audio controls style="width: 100%; height: 35px;">
                    <source src="${url}" type="audio/mp4">
                    <source src="${url}" type="audio/mpeg">
                    <source src="${url}" type="audio/webm">
                    <source src="${url}" type="audio/wav">
                    Tu navegador no soporta la reproducci√≥n de audio.
                </audio>
            </div>
        `;
    } 
    // Por defecto, tratar como IMAGEN
    else {
        return `
            <div style="margin-top:10px;">
                <img src="${url}" style="width:100%; border-radius:10px; border: 1px solid #b2945d;">
            </div>
        `;
    }
}

    // --- 5. SISTEMA DE COMENTARIOS Y APPS SCRIPT ---
   function cargarComentarios(punto) {
    const lista = document.getElementById('lista-comentarios');
    lista.innerHTML = "<em>Buscando en los archivos reales...</em>";
    
    fetch(APPS_SCRIPT_URL)
    .then(res => res.json())
    .then(data => {
        const filtrados = data.filter(d => d.punto === punto);
        if (filtrados.length === 0) {
            lista.innerHTML = "<em>Sin hallazgos en este punto todav√≠a.</em>";
            return;
        }

        // Construimos la lista asegurando que el multimedia se procese
        let htmlFinal = "";
        filtrados.forEach(d => {
            htmlFinal += `
                <div class="comentario-item">
                    <strong>${d.rol}:</strong> ${d.texto}
                    ${crearElementoMultimedia(d.archivo)} 
                </div>
            `;
        });
        lista.innerHTML = htmlFinal;
    })
    .catch(err => {
        console.error("Error al cargar:", err);
        lista.innerHTML = "<em>El Archivo Real no responde. Revisa la conexi√≥n.</em>";
    });
}

   function crearElementoMultimedia(url) {
    // Si no hay URL o es el texto por defecto, no pongas nada
    if (!url || url === "Sin archivo" || url.includes("Error") || url.trim() === "") return "";

    // Extraer el ID de Google Drive del enlace
    let idDrive = "";
    if (url.includes("id=")) {
        idDrive = url.split("id=")[1].split("&")[0];
    } else if (url.includes("/d/")) {
        idDrive = url.split("/d/")[1].split("/")[0];
    }

    if (!idDrive) return "";

    // Link para visualizaci√≥n directa
    const directUrl = `https://lh3.googleusercontent.com/d/${idDrive}`;

    // PROTECCI√ìN PARA IMAGEN
    const htmlImagen = `
        <div style="position:relative; user-select:none; margin-top:10px; border:1px solid #ddd; border-radius:8px; overflow:hidden;">
            <img src="${directUrl}" style="width:100%; display:block;" oncontextmenu="return false;">
            <div style="position:absolute; top:0; left:0; width:100%; height:100%; background:transparent;"></div>
        </div>`;

    // PROTECCI√ìN PARA AUDIO
    const htmlAudio = `
        <div style="margin-top:10px;">
            <audio controls controlsList="nodownload" oncontextmenu="return false;" style="width:100%;">
                <source src="https://docs.google.com/uc?export=download&id=${idDrive}" type="audio/mpeg">
                Tu navegador no soporta este audio.
            </audio>
        </div>`;

    // Si el nombre del archivo o la URL sugieren audio, mostramos el reproductor
    return (url.toLowerCase().match(/(audio|mp3|wav|m4a|ogg)/)) ? htmlAudio : htmlImagen;
}

    // --- 4. ENV√çO DE REPORTES ---
    function actualizarStatusArchivo() {
        const file = document.getElementById('archivo-oculto').files[0];
        const status = document.getElementById('status-archivo');
        if (file) { status.innerText = "üîó Listo para sellar: " + file.name; }
    }

  
function siguienteSala() {
    console.log("Clic en bot√≥n. Sala actual:", salaActual);

    if (salaActual < 15) {
        salaActual++;
        renderPoint(salaActual);
        const btnNext = document.getElementById('btn-next');
        if (btnNext) btnNext.style.display = 'none';
    } else {
        // Secuencia de fin de viaje
        const pantallaFinal = document.getElementById('pantalla-final');
        const rDisplay = document.getElementById('final-rol');
        const iDisplay = document.getElementById('final-id');

        if (pantallaFinal && rDisplay && iDisplay) {
            rDisplay.innerText = rolActivo.toUpperCase();
            iDisplay.innerText = viajeroID;
            pantallaFinal.style.display = 'flex'; // Usamos flex para centrar
            document.getElementById('panel-datos').style.display = 'none';
        }
    }
}


async function enviarReporte() {
    const textoElement = document.getElementById('texto-bitacora');
    const texto = textoElement ? textoElement.value : "";

    // 1. L√≥gica de "Salto de Sala" (C√≥digo secreto KNAAN)
    if (texto.trim().toUpperCase() === "KNAAN") {
        salaActual = 15; 
        renderPoint(salaActual); 
        const btnNext = document.getElementById('btn-next');
        if (btnNext) {
            btnNext.disabled = false;
            btnNext.style.display = "block";
            btnNext.innerText = "üìú FINALIZAR TRAVES√çA";
            btnNext.style.background = "#78281f";
        }
        if (textoElement) textoElement.value = ""; 
        return; 
    }

    const inputArchivo = document.getElementById('archivo-oculto');
    const archivo = inputArchivo ? inputArchivo.files[0] : null;
    const hitoNombre = baseDeDatos[rolActivo][salaActual - 1].n;

    // 2. VALIDACI√ìN FLEXIBLE: Solo bloquea si falta TODO (Texto y Archivo)
    if (!texto.trim() && !archivo) {
        alert("Navegante, debes escribir un hallazgo o adjuntar una evidencia para sellar el reporte.");
        return;
    }

    let payload = {
        idVisitante: viajeroID,
        rol: rolActivo,
        punto: hitoNombre,
        texto: texto,
        archivoB64: null,
        tipoMime: null,
        nombreArchivo: null
    };

    if (archivo) {
        const reader = new FileReader();
        const base64Promise = new Promise((resolve) => {
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(archivo);
        });
        
        payload.archivoB64 = await base64Promise;
        
        let mime = archivo.type;
        let nombreOriginal = archivo.name;

        // Detectamos si es audio por tipo o por extensi√≥n (iPhone)
        if ((mime && mime.includes("audio")) || nombreOriginal.toLowerCase().endsWith('.m4a') || nombreOriginal.toLowerCase().endsWith('.mp3')) {
            // TRUCO: Le ponemos el prefijo "AUDIO_" al nombre para que sea imposible de ignorar
            nombreOriginal = "AUDIO_" + nombreOriginal;
            if (!mime) mime = "audio/mp4"; 
        }
        
        payload.tipoMime = mime;
        payload.nombreArchivo = nombreOriginal;
    }

    // Enviamos al servidor
    enviarFetch(payload);
}

function enviarFetch(payload) {
    // Feedback visual inmediato para el investigador
    const btnNext = document.getElementById('btn-next');
    if (btnNext) {
        btnNext.style.display = "block";
        btnNext.disabled = true;
        btnNext.innerText = "‚åõ SELLANDO REPORTE...";
    }

    fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors', // Mantiene la velocidad de "disparar y olvidar"
        body: JSON.stringify(payload)
    })
    .then(() => {
        // --- 1. TU L√ìGICA ORIGINAL DE √âXITO ---
        alert("‚úÖ Reporte sellado con √©xito. El camino est√° despejado.");

        // --- 2. DESBLOQUEO Y L√ìGICA DE SALA 15 ---
        if (btnNext) {
            btnNext.disabled = false; // üîì Quita el bloqueo
            
            // Verificamos si es la √∫ltima sala para cambiar el texto y color
            if (salaActual === 15) {
                btnNext.innerText = "üìú FINALIZAR TRAVES√çA";
                btnNext.style.background = "#78281f"; // Color vino original
            } else {
                btnNext.innerText = "SIGUIENTE SALA ‚Üí";
                btnNext.style.background = "var(--oro)"; 
            }
        }

        // --- 3. TU L√ìGICA DE LIMPIEZA ORIGINAL ---
        document.getElementById('texto-bitacora').value = "";
        document.getElementById('archivo-oculto').value = "";
        if(document.getElementById('status-archivo')) {
            document.getElementById('status-archivo').innerText = "";
        }
        
        // Si tienes un contenedor de vista previa de imagen, tambi√©n convendr√≠a limpiarlo aqu√≠
        const preview = document.getElementById('preview-imagen'); 
        if(preview) preview.src = ""; 
    })
    .catch(err => {
        console.error(err);
        alert("Error de conexi√≥n. El Archivo Real no pudo recibir tu reporte.");
        if (btnNext) {
            btnNext.disabled = false;
            btnNext.innerText = "REINTENTAR ENV√çO";
        }
    });
}

</script>
