<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gale√≥n de Manila - Archivo Digital Completo</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+DW+Pica&family=Pirata+One&display=swap" rel="stylesheet">

<style>
    /* 1. VARIABLES Y BASES */
    :root { 
        --azul-p: #1b2631; 
        --pergamino: #fdf5e6; 
        --oro: #b2945d; 
        --tinta: #1a1a1a; 
        --verde-sello: #1e8449;
    }

    body, html { 
        margin: 0; padding: 0; 
        height: 100%; width: 100%; 
        font-family: 'IM Fell DW Pica', serif; 
        background: var(--azul-p); 
        overflow: hidden; 
    }

    /* 2. MEN√ö DE ROLES (Estilo Borrador con Radial Gradient) */
    #menu-roles { 
        display: flex; 
        flex-direction: column; 
        gap: 12px; 
        padding: 25px; 
        height: 100vh; 
        box-sizing: border-box; 
        justify-content: center; 
        background: radial-gradient(circle, #2e4053, #1b2631); 
        position: absolute; 
        width: 100%; 
        z-index: 3000; 
    }

    .tarjeta-rol { 
        background: var(--pergamino); 
        border: 4px double var(--oro); 
        padding: 15px; 
        text-align: center; 
        border-radius: 12px; 
        box-shadow: 0 8px 20px rgba(0,0,0,0.5); 
        cursor: pointer; 
        transition: transform 0.2s;
    }

    .tarjeta-rol:hover { transform: scale(1.02); }

    .tarjeta-rol h2 { 
        font-family: 'Pirata One', cursive; 
        margin: 0; 
        color: var(--azul-p); 
        font-size: 1.8rem; 
    }

    /* 3. MAPA */
    #map { 
        height: 100vh; 
        width: 100%; 
        position: absolute; 
        top: 0; 
        z-index: 1; 
        background: #aad3df; 
    }

    /* 4. PANEL DE DATOS (Elevado para proteger Marca de Agua) */
    #panel-datos { 
        position: absolute; 
        bottom: 90px; 
        width: 94%; 
        left: 3%; 
        height: 48vh; 
        background: var(--pergamino); 
        border: 3px solid var(--oro); 
        border-radius: 20px; 
        z-index: 2000; 
        display: none; 
        flex-direction: column; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.4); 
    }

    .contenido-scroll { padding: 0 20px 20px 20px; overflow-y: auto; flex-grow: 1; }

    /* 5. ELEMENTOS DE BIT√ÅCORA */
    .bitacora { margin-top: 20px; border-top: 2px dashed var(--oro); padding-top: 15px; }
    
    .input-estilo { 
        width: 100%; padding: 12px; margin: 8px 0; 
        border: 1.5px solid var(--oro); border-radius: 8px; 
        box-sizing: border-box; font-family: inherit; 
    }

    .btn-file { 
        background: #546e7a; color: white; width: 100%; padding: 15px; 
        border: none; border-radius: 10px; font-family: 'Pirata One'; 
        font-size: 1.2rem; margin-bottom: 10px; cursor: pointer; 
    }

    .btn-enviar { 
        background: var(--verde-sello); color: white; border: none; 
        width: 100%; padding: 18px; border-radius: 12px; 
        font-family: 'Pirata One'; font-size: 1.4rem; cursor: pointer;
        box-shadow: 0 4px 12px rgba(30, 132, 73, 0.4);
    }

    .btn-accion { 
        background: var(--azul-p); color: white; width: 100%; padding: 15px; 
        border: none; border-radius: 10px; font-family: 'Pirata One'; 
        font-size: 1.3rem; margin-top: 10px; display: none; 
    }

    .btn-accion:disabled {
        background-color: #95a5a6 !important;
        cursor: not-allowed;
        opacity: 0.6;
    }

    /* 6. MODALES Y BIT√ÅCORA FLOTANTE */
    .btn-bitacora-flotante {
        position: fixed !important; top: 20px !important; right: 20px !important;
        background-color: #5dade2 !important; color: white !important;
        padding: 12px 20px !important; border-radius: 30px !important;
        z-index: 999999 !important; border: 2px solid white !important;
        font-family: 'Pirata One', cursive; cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.4); display: none;
    }

    #modal-bitacora {
        display: none; position: fixed; z-index: 1000000;
        left: 0; top: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.8);
    }

    .cerrar-modal {
        position: absolute; right: 20px; top: 15px;
        font-size: 35px; color: #78281f; font-weight: bold; cursor: pointer;
    }

    /* 7. PANTALLA FINAL (Animaci√≥n y Textura Papyrus) */
    #pantalla-final {
        background-image: url('https://www.transparenttextures.com/patterns/papyrus.png');
        background-color: rgba(0,0,0,0.95);
    }

    #pantalla-final > div {
        animation: aparecerFinal 1.2s ease-out;
    }

    @keyframes aparecerFinal {
        from { opacity: 0; transform: scale(0.8) translateY(20px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }

    #status-archivo { color: var(--verde-sello); font-weight: bold; text-align: center; margin-bottom: 10px; }
</style>
<body>
    <button id="btn-bitacora-global" onclick="abrirBitacoraCompartida()" class="btn-bitacora-flotante" style="display: none;">
        üìú BIT√ÅCORA DEL GREMIO
    </button>

    <div id="menu-roles" style="display: flex; flex-direction: column; align-items: center; overflow-y: auto; padding-top: 20px;">
        
        <div style="text-align: center; width: 100%; margin-top: 109px; margin-bottom: 0px; padding: 10px 0;">
            <img src="https://www.sanildefonso.org.mx/expos/somospacifico/images/logo_txt.png" 
                 alt="Somos Pac√≠fico" 
                 style="width: 50%; max-width: 260px; height: auto; filter: brightness(0) invert(1); display: inline-block;">
        </div>

        <div class="tarjeta-rol" style="margin-top: -10px !important; width: 90%;" onclick="accesoRol('Comerciante')">
            <h2>Comerciante</h2>
            <p>Acapulco ‚Üí Manila</p>
        </div>
        
        <div class="tarjeta-rol" style="width: 90%;" onclick="accesoRol('Cart√≥grafo')">
            <h2>Cart√≥grafo</h2>
            <p>Acapulco ‚Üí Manila</p>
        </div>
        
        <div class="tarjeta-rol" style="width: 90%;" onclick="accesoRol('Navegante')">
            <h2>Navegante</h2>
            <p>Manila ‚Üí Acapulco</p>
        </div>
        
        <div class="tarjeta-rol" style="width: 90%;" onclick="accesoRol('Artesano')">
            <h2>Artesano</h2>
            <p>Manila ‚Üí Acapulco</p>
        </div>

        <div style="margin-top: 30px; padding-bottom: 40px;"></div>
    </div>
    </div>

    <div id="map"></div>

    <div id="panel-datos" style="display: none;">
        <div class="tirador"></div>
        <div class="contenido-scroll">
            <div class="header-sala">
                <span id="rol-nombre" style="background: var(--azul-p); color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.75rem;">ROL</span>
                <span id="sala-tag" style="font-weight: bold; color: var(--azul-p);">SALA 1/15</span>
                <span id="id-viajero-display" class="id-tag"></span>
            </div>

            <div class="card-historia">
                <h3 id="nombre-hito">Hito</h3>
                <p id="info-dato">Dato hist√≥rico...</p>
                <p id="info-pregunta" class="pregunta-box">Pregunta did√°ctica...</p>
            </div>

            <button id="btn-next" class="btn-accion" onclick="siguienteSala()" style="display: none;">Siguiente Sala ‚Üí</button>

            <div id="bitacora-container">
                <div class="bitacora">
                    <textarea id="texto-bitacora" class="input-estilo" placeholder="Escribe tu hallazgo..."></textarea>
                    <div id="status-archivo"></div> 
                    
                    <button type="button" class="btn-file" onclick="document.getElementById('archivo-oculto').click()">
                        üì∑ / üéôÔ∏è ADJUNTAR EVIDENCIA
                    </button>
                    <input type="file" id="archivo-oculto" accept="image/*,audio/*" style="display: none;" onchange="actualizarStatusArchivo()">
                    
                    <button onclick="enviarReporte()" class="btn-enviar">
                        üì© SELLAR REPORTE
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-bitacora" style="display: none; position: fixed; z-index: 10000000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center;">
        <div style="background: #fdf5e6; padding: 20px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; border: 3px double #b2945d;">
            <span onclick="document.getElementById('modal-bitacora').style.display='none'" style="float: right; cursor: pointer; font-size: 30px; font-weight: bold;">&times;</span>
            <h2 style="font-family: 'Pirata One'; color: #78281f; text-align: center;">Memorias de Navegantes</h2>
            <div id="lista-comentarios-modal"></div>
        </div>
    </div>

    <div id="pantalla-final" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); z-index: 20000000; justify-content: center; align-items: center; flex-direction: column;">
        <div style="text-align: center; border: 5px double #b2945d; background: #fdf5e6; padding: 40px; border-radius: 15px; max-width: 90%; width: 500px; box-shadow: 0 0 50px rgba(178, 148, 93, 0.5);">
            <h1 style="font-family: 'Pirata One', serif; font-size: 3rem; color: #78281f; margin-top: 0;">¬°EXPEDICI√ìN COMPLETADA!</h1>
            <hr style="border: 1px solid #b2945d; width: 80%; margin: 20px auto;">
            <p style="font-size: 1.2rem; line-height: 1.6; color: #1b2631;">
                Honorable <span id="final-rol" style="font-weight: bold; color: #78281f;"></span>, <br><br>
                Tus hallazgos han sido sellados en el <strong>Archivo del Pac√≠fico</strong>. 
                Gracias a tu pericia, la ruta permanece viva.
            </p>
            <div style="background: #eeeae0; padding: 15px; border-radius: 10px; margin: 25px 0; border: 1px dashed #78281f;">
                <p style="margin: 0; font-size: 0.9rem; color: #555;">ID DE VIAJERO:</p>
                <h2 id="final-id" style="margin: 5px 0; letter-spacing: 3px; color: #1b2631;"></h2>
            </div>
            <button onclick="location.reload()" style="background: #1b2631; color: white; padding: 15px 40px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold;">
                INICIAR NUEVA TRAVES√çA
            </button>
        </div>
    </div>

    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 500; pointer-events: none; display: flex; align-items: center; gap: 20px; opacity: 0.4;">
        <img src="https://www.sanildefonso.org.mx/expos/somospacifico/images/logo_txt.png" style="width: 100px; filter: brightness(0);">
    </div>
</body>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- 1. CONFIGURACI√ìN GLOBAL Y SEGURIDAD ---
    let viajeroID = "VIAJERO-" + Math.floor(1000 + Math.random() * 9000);
    let map;
    let salaActual = 1;
    let rolActivo = "";
    let rutaActual = [];

    const LLAVES_ACCESO = {
        "Comerciante": "Seda",
        "Cart√≥grafo": "Br√∫jula",
        "Navegante": "Proa",
        "Artesano": "Porcelana"
    };

    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwMNAn0fcQogSy6-qiZGUYPUfcIr57tgPUV6icfrvmlglUz1IAbVd2rvNN3hsqyVVen/exec"; 

    // --- 2. RUTA BAS
    const rutaBase = [
        { n: "Puerto de Manila", c: [14.59, 120.98] },
        { n: "Estrecho de San Bernardino", c: [12.58, 124.28] },
        { n: "Mar de Filipinas", c: [15.0, 132.0] },
        { n: "Islas Marianas (Guam)", c: [13.44, 144.79] },
        { n: "Pac√≠fico Norte", c: [30.0, 160.0] },
        { n: "Corriente de Kuroshio", c: [38.0, 175.0] },
        { n: "Meridiano 180", c: [40.0, 180.0] }, 
        { n: "Alta Mar Central", c: [38.0, 195.0] }, 
        { n: "Zona de Albatros", c: [35.0, 215.0] },
        { n: "Costa de California", c: [34.0, 240.0] },
        { n: "Baja California", c: [24.0, 248.0] },
        { n: "Mar de Cort√©s", c: [22.0, 252.0] },
        { n: "Cabo Corrientes", c: [20.4, 254.4] },
        { n: "Costa de Michoac√°n", c: [18.5, 257.0] },
        { n: "Puerto de Acapulco", c: [16.86, 260.11] }
    ];

   // --- 3. BASE DE DATOS (Contenido del Museo corregido) ---
    const baseDeDatos = {
        "Navegante": [
            { n: "Puerto de Manila", d: "Dato 1", p: "¬øPregunta 1?" },
            { n: "Estrecho de San Bernardino", d: "Dato 2", p: "¬øPregunta 2?" },
            { n: "Mar de Filipinas", d: "Dato 3", p: "¬øPregunta 3?" },
            { n: "Islas Marianas (Guam)", d: "Dato 4", p: "¬øPregunta 4?" },
            { n: "Pac√≠fico Norte", d: "Dato 5", p: "¬øPregunta 5?" },
            { n: "Corriente de Kuroshio", d: "Dato 6", p: "¬øPregunta 6?" },
            { n: "Meridiano 180", d: "Dato 7", p: "¬øPregunta 7?" },
            { n: "Alta Mar Central", d: "Dato 8", p: "¬øPregunta 8?" },
            { n: "Zona de Albatros", d: "Dato 9", p: "¬øPregunta 9?" },
            { n: "Costa de California", d: "Dato 10", p: "¬øPregunta 10?" },
            { n: "Punta de Baja California", d: "Dato 11", p: "¬øPregunta 11?" },
            { n: "Mar de Cort√©s", d: "Dato 12", p: "¬øPregunta 12?" },
            { n: "Cabo Corrientes", d: "Dato 13", p: "¬øPregunta 13?" },
            { n: "Costa de Michoac√°n", d: "Dato 14", p: "¬øPregunta 14?" },
            { n: "Puerto de Acapulco", d: "Dato 15", p: "¬øPregunta 15?" }
        ],
        "Artesano": [
            { n: "Puerto de Manila", d: "Dato 1", p: "¬øPregunta 1?" },
            { n: "Estrecho de San Bernardino", d: "Dato 2", p: "¬øPregunta 2?" },
            { n: "Mar de Filipinas", d: "Dato 3", p: "¬øPregunta 3?" },
            { n: "Islas Marianas (Guam)", d: "Dato 4", p: "¬øPregunta 4?" },
            { n: "Pac√≠fico Norte", d: "Dato 5", p: "¬øPregunta 5?" },
            { n: "Corriente de Kuroshio", d: "Dato 6", p: "¬øPregunta 6?" },
            { n: "Meridiano 180", d: "Dato 7", p: "¬øPregunta 7?" },
            { n: "Alta Mar Central", d: "Dato 8", p: "¬øPregunta 8?" },
            { n: "Zona de Albatros", d: "Dato 9", p: "¬øPregunta 9?" },
            { n: "Costa de California", d: "Dato 10", p: "¬øPregunta 10?" },
            { n: "Punta de Baja California", d: "Dato 11", p: "¬øPregunta 11?" },
            { n: "Mar de Cort√©s", d: "Dato 12", p: "¬øPregunta 12?" },
            { n: "Cabo Corrientes", d: "Dato 13", p: "¬øPregunta 13?" },
            { n: "Costa de Michoac√°n", d: "Dato 14", p: "¬øPregunta 14?" },
            { n: "Puerto de Acapulco", d: `Proximamente`, p: "¬øPregunta 15?" }
        ],
        "Cart√≥grafo": [
            { n: "Puerto de Acapulco", d: `El cacao, de origen mexicano, fue un bien de gran valor: adem√°s de consumirse, funcion√≥ como moneda en Mesoam√©rica.`, p: `Busca la pieza que creas que tendr√≠a el valor m√°s alto en el mercado de curiosidades de la √©poca. Toma una fotograf√≠a y escribe el precio estimado.` },
            { n: "Costa de Michoac√°n", d: `El C√≥dice Florentino no solo documenta aspectos culturales, sino tambi√©n descripciones del territorio.`, p: `Encuentra el Biombo de la Conquista. T√≥male una foto a tu detalle favorito.` },
            { n: "Cabo Corrientes", d: `En 1734, Joseph Gonz√°lez Cabrera Bueno public√≥ en Manila la gu√≠a m√°s importante para cruzar el Pac√≠fico.`, p: `Busca libro "voyage around the World de George Anson" y t√≥male una foto.` },
            { n: "Mar de Cort√©s", d: `El Cart√≥grafo usaba el Reloj Solar y la Calcograf√≠a para calcular la ruta exacta.`, p: `Mira el Reloj Solar. ¬øQu√© colocar√≠as en tu bit√°cora de viaje? graba un audio.` },
            { n: "Punta de Baja California", d: `La Ciudad de M√©xico era el eje financiero de la ruta. Aqu√≠, la Plata Mexicana se convert√≠a en la primera moneda global.`, p: `Observa los cuadros de los puertos, ¬øqu√© puerto consideras que cobra mayor importancia?` },
            { n: "Costa de California", d: `El cuadro del Z√≥calo es un ejercicio de cartograf√≠a te√≥rica.`, p: `¬øQu√© tan dif√≠cil crees que fue para el autor dibujar estas calles sin haberlas caminado?` },
            { n: "Zona de Albatros", d: `La palabra "petaca" se usaba originalmente para designar una maleta de palma tejida.`, p: `Si tuvieras que usar un emoji para representar el cacao en un mapa ¬øcu√°l usar√≠as?` },
            { n: "Alta Mar Central", d: `Los textos navales de Cabrera Bueno muestran c√≥mo la geograf√≠a y la religi√≥n estaban ligadas.`, p: `¬øCu√°l de estas piezas es m√°s dif√≠cil de dibujar y por qu√©?` },
            { n: "Meridiano 180", d: `El naufragio del gale√≥n San Felipe en 1596 provoc√≥ la ira de Toyotomi Hideyoshi.`, p: `¬øC√≥mo alterar√≠a tu desembarco la noticia de los m√°rtires franciscanos?` },
            { n: "Corriente de Kuroshio", d: `Palabras cotidianas como el "agua" llegaron a Filipinas desde Nueva Espa√±a.`, p: `Si tuvieras la encomienda de llevar una pieza a un noble novohispano, ¬øcu√°l elegir√≠as?` },
            { n: "Pac√≠fico Norte", d: `El sistema termin√≥ en 1815. Los mapas dejaron de ser "Secretos de Estado".`, p: `Graba una nota de voz explicando que la ruta trazada sigue viva en el arte.` },
            { n: "Islas Marianas (Guam)", d: `Como Cart√≥grafo, ves en los murales de Rivera la confirmaci√≥n de tu trabajo.`, p: `Identifica un elemento identitario en el mural y descr√≠belo.` },
            { n: "Mar de Filipinas", d: `Aunque el Gale√≥n termin√≥, la posici√≥n de M√©xico como "puente terrestre" no desapareci√≥.`, p: `Graba un audio: ¬øQu√© consejos dar√≠as a los cart√≥grafos del futuro?` },
            { n: "Estrecho de San Bernardino", d: `Transformando la cartograf√≠a militar en cartograf√≠a civil y art√≠stica.`, p: `Busca en la pintura de Rivera un elemento natural (volcanes, costas o valles) identitario de M√©xico.` },
            { n: "Puerto de Manila", d: `Culminaci√≥n de la ruta transpac√≠fica.`, p: `De la sala ¬øQu√© libro te resulta llamativo? escribe el nombre.` }
        ],
        "Comerciante": [
            { n: "Puerto de Acapulco", d: `El cacao, de origen mexicano, fue un bien de gran valor.`, p: `Busca la pieza con mayor valor en el mercado de curiosidades.` },
            { n: "Costa de Michoac√°n", d: `Los biombos formaban parte de los objetos m√°s codiciados.`, p: `¬øCu√°l ser√≠a el m√©todo para resguardar el biombo en su traslado?` },
            { n: "Cabo Corrientes", d: `Las bit√°coras registraban legalmente los bienes de lujo autorizados.`, p: `¬øQu√© consideras que ser√≠a una "mercanc√≠a legal"?` },
            { n: "Mar de Cort√©s", d: `La manta simboliza el tiempo de maduraci√≥n de la inversi√≥n.`, p: `¬øQu√© riesgo te preocupar√≠a m√°s? Graba un audio.` },
            { n: "Punta de Baja California", d: `Exist√≠a un l√≠mite de carga llamada "permisi√≥n".`, p: `¬øQu√© llevar√≠as para vender desde Manila? Graba un audio.` },
            { n: "Costa de California", d: `El pari√°n era un mercado especializado en bienes de lujo.`, p: `Toma una foto donde colocar√≠as tu puesto en la plaza.` },
            { n: "Zona de Albatros", d: `Las vajillas de porcelana china fueron productos valios√≠simos.`, p: `¬øCu√°les son los colores principales de la porcelana en la sala?` },
            { n: "Alta Mar Central", d: `El valor de lo transportado era mucho mayor al permitido.`, p: `¬øQu√© piezas le vender√≠as a un sacerdote novohispano?` },
            { n: "Meridiano 180", d: `Sin el permiso oficial, ninguna mercanc√≠a pod√≠a desembarcar en Jap√≥n.`, p: `¬øQu√© le dir√≠as al oficial que te pide el Sello Bermejo? Graba audio.` },
            { n: "Corriente de Kuroshio", d: `Los trajes de los mestizos reflejan una nueva oportunidad comercial.`, p: `¬øEn qu√© condiciones se deber√≠an transportar estas prendas?` },
            { n: "Pac√≠fico Norte", d: `El Gale√≥n dej√≥ de ser rentable debido a las guerras de independencia.`, p: `¬øQu√© objeto fue el m√°s dif√≠cil de conseguir al cerrar la ruta?` },
            { n: "Islas Marianas (Guam)", d: `La riqueza de M√©xico hoy reside en esa mezcla √∫nica.`, p: `Toma foto de un elemento que te recuerde a la riqueza del pasado.` },
            { n: "Mar de Filipinas", d: `Presi√≥n de nuevas potencias comerciales en el siglo XIX.`, p: `¬øQu√© objeto fue el m√°s dif√≠cil de conseguir? Com√©ntalo.` },
            { n: "Estrecho de San Bernardino", d: `El producto final de ese mestizaje cultural.`, p: `Toma una fotograf√≠a y explica: ¬øPor qu√© este arte tiene tanto valor internacional?` },
            { n: "Puerto de Manila", d: `El inicio de la carga del Gale√≥n.`, p: `De la sala ¬øQu√© libro te resulta llamativo? escribe el nombre.` }
        ]
    };

    // --- 4. FUNCIONES DE INTERFAZ Y MAPA ---
 function accesoRol(rol) {
        const pass = prompt(`Ingrese la contrase√±a de acceso para el perfil de ${rol}:`);
        if (pass === LLAVES_ACCESO[rol]) {
            rolActivo = rol;
            salaActual = 1;
            rutaActual = (rol === "Cart√≥grafo" || rol === "Comerciante") ? [...rutaBase].reverse() : [...rutaBase];

			viajeroID = "VIA-" + Math.floor(Math.random() * 9000 + 1000);
            
            document.getElementById('menu-roles').style.display = 'none';
            document.getElementById('panel-datos').style.display = 'flex';
            document.getElementById('rol-nombre').innerText = rol.toUpperCase();
            
            // Inyectamos el ID en el HTML
            document.getElementById('id-viajero-display').innerText = viajeroID;
            
            setTimeout(initMap, 100);
        } else { 
            alert("Contrase√±a incorrecta. El Archivo Real permanece cerrado."); 
        }
    }

    function initMap() {
        if (map) map.remove(); 
        map = L.map('map', { zoomControl: false }).setView([20, 180], 3);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        document.getElementById('map').style.filter = "sepia(0.3) hue-rotate(185deg) brightness(0.9)";
        
        // Forzar redibujado para evitar pantalla azul
        setTimeout(() => { map.invalidateSize(); }, 200);
        renderPoint(1);
    }

  function renderPoint(id) {
    const hito = rutaActual[id-1];
    const info = baseDeDatos[rolActivo][id-1];
    const marker = L.marker(hito.c).addTo(map);
    
    marker.on('click', () => {
        document.getElementById('nombre-hito').innerText = info.n;
        document.getElementById('info-dato').innerText = info.d;
        document.getElementById('info-pregunta').innerText = info.p;
        document.getElementById('sala-tag').innerText = `Sala ${id}/15`;

        // --- L√ìGICA DEL CANDADO AQU√ç ---
        const btnNext = document.getElementById('btn-next');
        if (btnNext) {
            btnNext.style.display = 'block'; // Lo mostramos
            btnNext.disabled = true;        // üîí Lo bloqueamos
            btnNext.innerText = "üîí RESPONDE PARA AVANZAR"; // Texto de aviso
        }

        // Limpiamos el texto de la bit√°cora anterior para que escriban de nuevo
        document.getElementById('texto-bitacora').value = "";
        
        map.flyTo(hito.c, 4);
        cargarComentarios(info.n);
    });

    if (id > 1) {
        L.polyline([rutaActual[id-2].c, hito.c], { 
            color: '#1b2631', 
            weight: 3, 
            dashArray: '8, 12', 
            opacity: 0.6 
        }).addTo(map);
    }
}
function siguienteSala() {
    if (salaActual < 15) {
        salaActual++;
        renderPoint(salaActual);
        // Al cambiar de sala, el bot√≥n se oculta hasta que el usuario responda la nueva pregunta
        document.getElementById('btn-next').style.display = 'none';
    } else {
        // Si ya estamos en la 15 (salaActual === 15) y presionan el bot√≥n:
        const pantallaFinal = document.getElementById('pantalla-final');
        document.getElementById('final-rol').innerText = rolActivo;
        document.getElementById('final-id').innerText = viajeroID;
        pantallaFinal.style.display = 'block';
        document.getElementById('panel-datos').style.display = 'none';
    }
}

	// --- ACTIVAR BOT√ìN TRAS CONTRASE√ëA ---
function accesoRol(rol) {
    const pass = prompt(`Ingrese la contrase√±a para ${rol}:`);
    if (pass === LLAVES_ACCESO[rol]) {
        rolActivo = rol; // Guardamos el oficio
        salaActual = 1;
        rutaActual = (rol === "Cart√≥grafo" || rol === "Comerciante") ? [...rutaBase].reverse() : [...rutaBase];
        
        document.getElementById('menu-roles').style.display = 'none';
        document.getElementById('panel-datos').style.display = 'flex';
		document.getElementById('rol-nombre').innerText = rol.toUpperCase();
            document.getElementById('id-viajero-display').innerText = viajeroID;
        
        // MOSTRAR EL BOT√ìN AZUL (Ahora s√≠)
        const btn = document.getElementById('btn-bitacora-global');
        if(btn) btn.style.display = 'block';

        setTimeout(initMap, 100);
    } else {
        alert("Contrase√±a incorrecta.");
    }
}

// --- ABRIR GALER√çA PROPIA DEL DATO/OFICIO ---
function abrirBitacoraCompartida() {
    const modal = document.getElementById('modal-bitacora');
    const lista = document.getElementById('lista-comentarios-modal');
    const hitoActual = document.getElementById('nombre-hito').innerText;

    if (!hitoActual || hitoActual === "Hito") return alert("Selecciona un punto primero.");

    modal.style.display = "block";
    lista.innerHTML = "<p style='text-align:center;'>Buscando bit√°coras de " + rolActivo + "...</p>";

    fetch(APPS_SCRIPT_URL)
    .then(res => res.json())
    .then(data => {
        // FILTRADO DOBLE: Por el Punto Y por el Rol (Oficio)
        const filtrados = data.filter(d => d.punto === hitoActual && d.rol === rolActivo);
        
        if (filtrados.length === 0) {
            lista.innerHTML = `<p style='text-align:center; padding:20px;'>Nadie del gremio de <b>${rolActivo}s</b> ha dejado evidencias aqu√≠.</p>`;
            return;
        }

        lista.innerHTML = filtrados.map(d => `
            <div class="comentario-item" style="background:white; padding:15px; border-radius:10px; margin-bottom:15px; border-left: 5px solid #5dade2;">
                <small style="color:#7f8c8d;">ID: ${d.id}</small>
                <p style="margin:8px 0;">${d.texto}</p>
                ${crearElementoMultimedia(d.archivo)}
            </div>
        `).join("");
    })
    .catch(() => lista.innerHTML = "Error al conectar con el Archivo Real.");
}

function cerrarBitacora() {
    document.getElementById('modal-bitacora').style.display = "none";
}


    // --- 5. SISTEMA DE COMENTARIOS Y APPS SCRIPT ---
   function cargarComentarios(punto) {
    const lista = document.getElementById('lista-comentarios');
    lista.innerHTML = "<em>Buscando en los archivos reales...</em>";
    
    fetch(APPS_SCRIPT_URL)
    .then(res => res.json())
    .then(data => {
        const filtrados = data.filter(d => d.punto === punto);
        if (filtrados.length === 0) {
            lista.innerHTML = "<em>Sin hallazgos en este punto todav√≠a.</em>";
            return;
        }

        // Construimos la lista asegurando que el multimedia se procese
        let htmlFinal = "";
        filtrados.forEach(d => {
            htmlFinal += `
                <div class="comentario-item">
                    <strong>${d.rol}:</strong> ${d.texto}
                    ${crearElementoMultimedia(d.archivo)} 
                </div>
            `;
        });
        lista.innerHTML = htmlFinal;
    })
    .catch(err => {
        console.error("Error al cargar:", err);
        lista.innerHTML = "<em>El Archivo Real no responde. Revisa la conexi√≥n.</em>";
    });
}

   function crearElementoMultimedia(url) {
    // Si no hay URL o es el texto por defecto, no pongas nada
    if (!url || url === "Sin archivo" || url.includes("Error") || url.trim() === "") return "";

    // Extraer el ID de Google Drive del enlace
    let idDrive = "";
    if (url.includes("id=")) {
        idDrive = url.split("id=")[1].split("&")[0];
    } else if (url.includes("/d/")) {
        idDrive = url.split("/d/")[1].split("/")[0];
    }

    if (!idDrive) return "";

    // Link para visualizaci√≥n directa
    const directUrl = `https://lh3.googleusercontent.com/d/${idDrive}`;

    // PROTECCI√ìN PARA IMAGEN
    const htmlImagen = `
        <div style="position:relative; user-select:none; margin-top:10px; border:1px solid #ddd; border-radius:8px; overflow:hidden;">
            <img src="${directUrl}" style="width:100%; display:block;" oncontextmenu="return false;">
            <div style="position:absolute; top:0; left:0; width:100%; height:100%; background:transparent;"></div>
        </div>`;

    // PROTECCI√ìN PARA AUDIO
    const htmlAudio = `
        <div style="margin-top:10px;">
            <audio controls controlsList="nodownload" oncontextmenu="return false;" style="width:100%;">
                <source src="https://docs.google.com/uc?export=download&id=${idDrive}" type="audio/mpeg">
                Tu navegador no soporta este audio.
            </audio>
        </div>`;

    // Si el nombre del archivo o la URL sugieren audio, mostramos el reproductor
    return (url.toLowerCase().match(/(audio|mp3|wav|m4a|ogg)/)) ? htmlAudio : htmlImagen;
}

    // --- 4. ENV√çO DE REPORTES ---
    function actualizarStatusArchivo() {
        const file = document.getElementById('archivo-oculto').files[0];
        const status = document.getElementById('status-archivo');
        if (file) { status.innerText = "üìé Listo para sellar: " + file.name; }
    }

  // --- FUNCI√ìN PARA AVANZAR O FINALIZAR ---
function siguienteSala() {
    console.log("Clic en bot√≥n. Sala actual:", salaActual);

    if (salaActual < 15) {
        salaActual++;
        renderPoint(salaActual);
        const btnNext = document.getElementById('btn-next');
        if (btnNext) btnNext.style.display = 'none';
    } else {
        // Secuencia de fin de viaje
        const pantallaFinal = document.getElementById('pantalla-final');
        const rDisplay = document.getElementById('final-rol');
        const iDisplay = document.getElementById('final-id');

        if (pantallaFinal && rDisplay && iDisplay) {
            rDisplay.innerText = rolActivo.toUpperCase();
            iDisplay.innerText = viajeroID;
            pantallaFinal.style.display = 'flex'; // Usamos flex para centrar
            document.getElementById('panel-datos').style.display = 'none';
        }
    }
}

// --- FUNCI√ìN PARA ENVIAR REPORTE (CON ATAJO KNAAN) ---
async function enviarReporte() {
    const textoElement = document.getElementById('texto-bitacora');
    const texto = textoElement ? textoElement.value : "";

    // --- ATAJO DE DESARROLLADOR: KNAAN ---
    if (texto.trim().toUpperCase() === "KNAAN") {
        salaActual = 15; 
        renderPoint(salaActual); 
        const btnNext = document.getElementById('btn-next');
        if (btnNext) {
            btnNext.disabled = false;
            btnNext.style.display = "block";
            btnNext.innerText = "üìú FINALIZAR TRAVES√çA";
            btnNext.style.background = "#78281f";
        }
        if (textoElement) textoElement.value = ""; 
        return; 
    }

    // --- FLUJO NORMAL ---
    const inputArchivo = document.getElementById('archivo-oculto');
    const archivo = inputArchivo ? inputArchivo.files[0] : null;
    const hitoNombre = baseDeDatos[rolActivo][salaActual - 1].n;

    if (!texto.trim() && !archivo) {
        alert("Navegante, debes escribir algo o adjuntar una evidencia.");
        return;
    }

    let payload = {
        idVisitante: viajeroID,
        rol: rolActivo,
        punto: hitoNombre,
        texto: texto,
        archivoB64: null,
        tipoMime: null,
        nombreArchivo: null
    };

    if (archivo) {
        const reader = new FileReader();
        const base64Promise = new Promise((resolve) => {
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(archivo);
        });
        payload.archivoB64 = await base64Promise;
        payload.tipoMime = archivo.type;
        payload.nombreArchivo = archivo.name;
    }

    enviarFetch(payload);
}

 function enviarFetch(payload) {
    fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify(payload)
    })
    .then(() => {
        // 1. Notificaci√≥n de √©xito
        alert("‚úÖ Reporte sellado con √©xito. El camino est√° despejado.");

        // 2. DESBLOQUEO DEL BOT√ìN CON L√ìGICA DE CIERRE
        const btnNext = document.getElementById('btn-next');
        if (btnNext) {
            btnNext.disabled = false; // üîì Quita el bloqueo
            btnNext.style.display = "block"; // Asegura que se vea

            // Verificamos si es la √∫ltima sala para cambiar el texto
            if (salaActual === 15) {
                btnNext.innerText = "üìú FINALIZAR TRAVES√çA";
                btnNext.style.background = "#78281f"; // Color vino/distintivo para el final
            } else {
                btnNext.innerText = "SIGUIENTE SALA ‚Üí";
                btnNext.style.background = "var(--oro)"; 
            }
        }

        // 3. Limpieza de los campos (Para la siguiente sala)
        document.getElementById('texto-bitacora').value = "";
        document.getElementById('archivo-oculto').value = "";
        if(document.getElementById('status-archivo')) {
            document.getElementById('status-archivo').innerText = "";
        }
    })
    .catch(err => {
        console.error(err);
        alert("Error de conexi√≥n. El Archivo Real no pudo recibir tu reporte.");
    });
}
</script>






